<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8" />
    <title>Chapter 6: 비극적인 영원한 전설</title>
    <link rel="stylesheet"
          href="https://cdn.jsdelivr.net/gh/orioncactus/pretendard/dist/web/static/pretendard.css" />
    <style>
        /* 1. 공통 스타일 */
        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            background: #000;
            color: #fff;
            font-family: "Pretendard", sans-serif;
            overflow: hidden;
            width: 100vw;
            height: 100vh;
        }

        /* 2. 인트로 화면 */
        .intro-section {
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            background: black;
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 99999;
            opacity: 1;
            transition: opacity 1.0s ease;
        }

        .intro-text {
            color: #fff;
            font-size: 24px;
            font-weight: 500;
            line-height: 1.6;
            text-align: center;
            white-space: pre-wrap; 
        }

        /* 3. 비극 메시지 오버레이 */
        .tragedy-section {
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            background: black; 
            display: none; /* 평소엔 숨김 */
            z-index: 99997; 
            opacity: 0;
            transition: opacity 1.5s ease;
        }

        /* 장면 컨테이너 공통 스타일 */
        .scene-container {
            position: absolute;
            top: 50%; left: 50%;
            transform: translate(-50%, -50%);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            width: 100%;
            transition: all 1.5s cubic-bezier(0.25, 1, 0.5, 1);
        }

        /* 장면 1: 텍스트만 */
        #scene1 { opacity: 1; }
        #scene1.move-down-out {
            opacity: 0;
            transform: translate(-50%, 20%);
        }

        /* 장면 2: 사진 + 텍스트 + 버튼 */
        #scene2 {
            opacity: 0;
            transform: translate(-50%, -120%);
        }
        #scene2.move-down-in {
            opacity: 1;
            transform: translate(-50%, -50%);
        }

        /* 텍스트 및 이미지 스타일 */
        .tragedy-text {
            color: #fff;
            font-size: 28px;
            font-weight: 600;
            line-height: 1.6;
            text-align: center;
            letter-spacing: -0.5px;
            white-space: pre-wrap;
        }

        .tragedy-img {
            width: 900px; 
            height: auto;
            box-shadow: 0 0 30px rgba(255,255,255,0.15);
            margin-bottom: 30px;
        }

        /* [추가됨] 마지막 경기 버튼 스타일 */
        #nextSceneBtn {
            margin-top: 40px; /* 텍스트와의 간격 */
            padding: 10px 20px;
            font-size: 16px;
            font-weight: 500;
            background: #fff;
            color: #000;
            border: none;
            cursor: pointer;
            opacity: 0; /* 처음엔 투명 */
            transition: opacity 1.0s ease, transform 0.2s;
        }
        #nextSceneBtn:hover {
            background: #ddd;
            transform: scale(1.05);
        }

        /* 4. 헤더 */
        header {
            position: fixed;
            top: 0; width: 100%;
            padding: 18px 0;
            text-align: center;
            background: rgba(0, 0, 0, 0.8);
            font-size: 18px;
            font-weight: 500;
            z-index: 100;
            display: none; 
        }

        /* 5. 메인 콘텐츠 */
        main {
            width: 100%; height: 100%;
            position: relative;
            display: flex;
            align-items: center;
            justify-content: center;
            opacity: 0;
            transition: opacity 1.0s ease;
            flex-direction: column;
            overflow: hidden;
        }

        @keyframes zoomEffect {
            0% { transform: scale(1.0); }
            100% { transform: scale(1.15); }
        }

        .bg-layer {
            position: absolute; inset: 0;
            background-size: cover; background-position: center;
            z-index: 1; 
            opacity: 0.8;
            background-image: url('map.png'); 
            animation: zoomEffect 20s linear infinite alternate;
        }

        .gradient-overlay {
            position: absolute;
            bottom: 0; left: 0; width: 100%; height: 60%;
            background: linear-gradient(to top, rgba(0, 0, 0, 1) 10%, rgba(0, 0, 0, 0) 100%);
            z-index: 2;
            pointer-events: none;
        }

        /* 6. 텍스트 섹션 */
        .story-section {
            position: relative;
            z-index: 10;
            width: 100%;
            height: 100%;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            text-align: center;
            padding-top: 100px;
        }

        .main-title {
            font-size: 48px; 
            font-weight: 800;
            letter-spacing: 2px;
            margin-bottom: 15px;
            text-shadow: 0 4px 10px rgba(0,0,0,0.5);
            color: white;
        }

        .sub-desc {
            font-size: 22px;
            font-weight: 600;
            color: white;
        }

        /* 7. 영상 오버랩 스타일 */
        .video-wrapper {
            position: fixed;
            top: 50%; left: 50%;
            transform: translate(-50%, -50%);
            width: 60vw;
            max-width: 800px;
            aspect-ratio: 16 / 9;
            z-index: 9999;
            opacity: 0;
            transition: opacity 1.5s ease;
            box-shadow: 0 0 50px rgba(0,0,0,1);
            background: #000;
        }
        
        .video-wrapper video {
            width: 100%;
            height: 100%;
            object-fit: cover;
            display: block;
        }

        /* 8. 네비게이션 버튼 */
        .nav-btns {
            position: fixed; bottom: 0; left: 0; width: 100%;
            display: flex; justify-content: space-between; align-items: flex-end;
            padding: 0 30px 20px;
            z-index: 99999;
            pointer-events: none;
        }
        .nav-btns a {
            pointer-events: all; display: block;
            opacity: 1; 
        }
        .nav-btns img {
            height: 50px; opacity: 0.8; transition: transform 0.2s, opacity 0.2s;
        }
        .nav-btns img:hover { transform: scale(1.1); opacity: 1; }

        /* ▼▼▼ [추가] 마지막 영상 전체화면 스타일 ▼▼▼ */
        .fullscreen-video-layer {
            position: fixed;
            top: 0; left: 0; width: 100vw; height: 100vh;
            background: #000;
            z-index: 99998; /* 가장 위에 오도록 아주 높은 값 설정 */
            display: none;   /* 처음엔 안 보임 */
            opacity: 0;
            transition: opacity 1.0s ease;
        }

        .fullscreen-video-layer video {
            width: 100%;
            height: 100%;
            object-fit: cover; /* 화면 꽉 채우기 */
        }

    </style>
</head>
<body>
    <audio id="ch6BGM" src="ch6_bg.mp3" loop preload="auto"></audio>

    <section id="introSection" class="intro-section">
        <div id="introText" class="intro-text"></div>
    </section>

    <section id="tragedySection" class="tragedy-section">
        <div id="scene1" class="scene-container">
            <div id="tragedyText1" class="tragedy-text"></div>
        </div>

        <div id="scene2" class="scene-container">
            <img src="last.png" alt="Senna Worrying" class="tragedy-img">
            <div id="tragedyText2" class="tragedy-text" style="font-size: 22px; color: #ddd;"></div>
            
            <button id="nextSceneBtn">
                세나의 마지막 경기 ▶
            </button>
        </div>
    </section>

    <header id="chapterHeader">
        비극적인 영원한 전설 (1994년)
    </header>

    <main id="mainContent">
        <div class="bg-layer"></div>
        <div class="gradient-overlay"></div>

        <section class="story-section">
            <h1 class="main-title">1994년 4월 30일</h1>
            <p class="sub-desc">산마리노 이몰라 그랑프리</p>
        </section>

        <div id="videoContainer" class="video-wrapper">
            <video id="myVideo" muted autoplay>
                <source src="grandprix.mp4" type="video/mp4">
            </video>
        </div>


    <div id="lastRaceVideoContainer" class="fullscreen-video-layer">
        <video id="lastRaceVideo" playsinline>
            <source src="senna_last.mp4" type="video/mp4"> 
        </video>
    </div>
        </body>
    </main>

    <div class="nav-btns" id="navBtns">
        <a href="chapter5.html" class="btn-back"><img src="btn_back.png" alt="Back"></a>
        <a href="last.html" class="btn-forward"><img src="btn_forward.png" alt="Forward"></a>
    </div>

    <script>
        // 변수 선언
        const introSection = document.getElementById('introSection');
        const introText = document.getElementById('introText');
        const chapterHeader = document.getElementById('chapterHeader');
        const mainContent = document.getElementById('mainContent');
        const navBtns = document.getElementById('navBtns').querySelectorAll('a');
        
        const videoContainer = document.getElementById('videoContainer'); 
        const myVideo = document.getElementById('myVideo'); 
        
        const tragedySection = document.getElementById('tragedySection');
        const scene1 = document.getElementById('scene1');
        const scene2 = document.getElementById('scene2');
        const tragedyText1 = document.getElementById('tragedyText1');
        const tragedyText2 = document.getElementById('tragedyText2');
        const nextSceneBtn = document.getElementById('nextSceneBtn');

        const introMessage = "비극적인 영원한 전설 (1994년)";
        const msg1 = "심텍 소속의 롤란트 라첸베르거가\n퀄리파잉 도중 충돌 사고로 사망"; 
        const msg2 = "해당 사고를 실시간으로 본 세나는 큰 불안감에 빠지지만\n레이싱 카를 타고 폴포지션을 차지한다";

        const lastRaceVideoContainer = document.getElementById('lastRaceVideoContainer');
        const lastRaceVideo = document.getElementById('lastRaceVideo');
        
        // ⭐ BGM 관련 변수 및 상수 (최종 통합) ⭐
        const ch6BGM = document.getElementById("ch6BGM");
        const BGM_NORMAL_VOLUME = 0.4; // 배경음악 볼륨 설정
        const FADE_DURATION = 3000;    // BGM 페이드인 시간 (3초)


        function typeText(element, text, speed, callback) {
            let i = 0;
            element.innerText = ""; 
            const timer = setInterval(() => {
                element.innerText += text[i];
                i++;
                if (i >= text.length) {
                    clearInterval(timer);
                    if (callback) callback();
                }
            }, speed);
        }

        // ⭐ [추가] 오디오 페이드 인 함수
        function fadeInMusic(audioEl, duration, targetVolume) {
            if (!audioEl) return;
            const stepTime = 50;
            const step = targetVolume / (duration / stepTime);

            if (audioEl.__volumeInterval) clearInterval(audioEl.__volumeInterval);

            audioEl.volume = 0;
            // BGM 재생 시작 (사용자 상호작용 없이 재생될 경우 에러를 무시합니다)
            audioEl.play().catch(e => console.log("BGM autoplay failed:", e));

            let currentVolume = 0;
            audioEl.__volumeInterval = setInterval(() => {
                currentVolume += step;
                if (currentVolume >= targetVolume) {
                    currentVolume = targetVolume;
                    clearInterval(audioEl.__volumeInterval);
                }
                audioEl.volume = currentVolume;
            }, stepTime);
        }

        // ⭐ [추가] 오디오 페이드 아웃 함수 (볼륨 감소 및 정지)
        function fadeOutMusic(audioEl, duration) {
            if (!audioEl) return;
            const stepTime = 50;
            const startVolume = audioEl.volume;
            if (startVolume <= 0) {
                audioEl.pause();
                return;
            }

            const step = startVolume / (duration / stepTime);

            if (audioEl.__volumeInterval) clearInterval(audioEl.__volumeInterval);

            let currentVolume = startVolume;
            audioEl.__volumeInterval = setInterval(() => {
                currentVolume -= step;
                if (currentVolume <= 0) {
                    currentVolume = 0;
                    clearInterval(audioEl.__volumeInterval);
                    audioEl.pause();
                    audioEl.volume = 0;
                    return;
                }
                audioEl.volume = currentVolume;
            }, stepTime);
        }

        // -------------------------------------------------------------------
        // ⭐ 최종 실행 로직 (BGM 즉시 재생 및 인트로 시퀀스 시작) ⭐
        // -------------------------------------------------------------------

        window.onload = () => {
            // BGM 페이드인 호출 (인트로 시작과 동시에 재생)
            fadeInMusic(ch6BGM, FADE_DURATION, BGM_NORMAL_VOLUME); 

            // 인트로 시작
            typeText(introText, introMessage, 80, () => {
                setTimeout(() => {
                    introSection.style.opacity = 0;
                    setTimeout(() => {
                        introSection.style.display = 'none';
                        chapterHeader.style.display = 'block';
                        mainContent.style.opacity = 1;
                        navBtns.forEach(btn => btn.style.opacity = 1);

                        setTimeout(() => {
                            videoContainer.style.opacity = 1; 
                            myVideo.play().catch(e => console.log("Video autoplay failed.")); 
                        }, 3000); 

                    }, 1000); 
                }, 1000); 
            });
        };

        // -------------------------------------------------------------------
        // 영상 종료 후 스토리 시퀀스
        // -------------------------------------------------------------------
        myVideo.addEventListener('ended', () => {
            // ⭐ [수정] tragedySection의 display를 'flex'로 설정 ⭐
            tragedySection.style.display = 'flex'; 
            setTimeout(() => {
                tragedySection.style.opacity = 1;
                
                // 1. 첫 번째 메시지 타이핑
                setTimeout(() => {
                    typeText(tragedyText1, msg1, 80, () => {
                        
                        // 2. 2초 대기 후 장면 전환
                        setTimeout(() => {
                            scene1.classList.add('move-down-out');
                            scene2.classList.add('move-down-in');

                            // 3. 두 번째 메시지 타이핑
                            setTimeout(() => {
                                typeText(tragedyText2, msg2, 60, () => {
                                    
                                    // 4. 타이핑 끝난 후 버튼 등장
                                    setTimeout(() => {
                                        nextSceneBtn.style.opacity = 1;
                                    }, 500);

                                });
                            }, 1000); 

                        }, 2000); 

                    });
                }, 500);
            }, 100);
        });

        // -------------------------------------------------------------------
        // 버튼 클릭 시 (마지막 경기 영상 보기) - BGM 정지 로직 포함
        // -------------------------------------------------------------------
        nextSceneBtn.addEventListener('click', () => {
            // ⭐ [적용] 1) BGM 페이드 아웃 및 정지 ⭐
            fadeOutMusic(ch6BGM, 1000); // 1초에 걸쳐 BGM 페이드 아웃

            // 2) 비극 오버레이 숨기기
            tragedySection.style.opacity = 0; 

            // 3) 영상 컨테이너 준비 및 재생 시작
            setTimeout(() => {
                tragedySection.style.display = 'none';
                lastRaceVideoContainer.style.display = 'flex';
                
                // 부드럽게 나타나면서 재생 시작
                setTimeout(() => {
                    lastRaceVideoContainer.style.opacity = 1;
                    lastRaceVideo.play().catch(e => console.log("Video autoplay failed."));
                }, 100);
            }, 1000); // BGM 페이드 아웃 시간(1000ms)에 맞춰 영상 전환
        });

        // -------------------------------------------------------------------
        // 영상 종료 후 다음 페이지 이동
        // -------------------------------------------------------------------
        lastRaceVideo.addEventListener('ended', () => {
            window.location.href = 'last.html';
        });
        

    </script>
</body>
</html>